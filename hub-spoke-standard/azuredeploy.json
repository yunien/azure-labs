{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "envName": {
            "type": "string",
            "metadata": {
                "description": "env"
            }
        },
        "suffix": {
            "type": "string",
            "metadata": {
                "description": "suffix string"
            }
        },
        "tags": {
            "type": "object",
            "metadata": {
                "description": "The tags that wil be associated to the resources"
            },
            "defaultValue": {
                "environment": "lab",
                "creater": "electrum"
            }
        },
        "networkWatcherRg": {
            "type": "string",
            "metadata": {
                "description": "network Watcher Resource Group"
            }
        },
        "location": {
            "type": "string",
            "metadata": {
                "description": "Location of the resource group"
            },
            "defaultValue": "[deployment().location]"
        },
        "transitVnetCidr": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "transitGatewaySubnetCidr": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "transitBastionSubnetCidr": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "transitFwSubnetCidr": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "adminObjectId": {
            "type": "string",
            "metadata": {
                "description": "The object ID of the user or group who will have full permissons on Azure Key Vault"
            }
        },
        "vmAdminUsername": {
            "type": "string"
        },
        "vmAdminPassword": {
            "type": "securestring"
        }
    },
    "variables": {
        "makeSuffix": "[concat(parameters('envName'),'-',parameters('location'),'-',parameters('suffix'))]",
        "transitDeploymentName": "[concat('deploy-transit-',variables('makeSuffix'))]",
        "transitTemplateUrl": "[uri(deployment().properties.templateLink.uri, 'templateLink/transitdeploy.json')]",
        "sharedDeploymentName": "[concat('deploy-shared-',variables('makeSuffix'))]",
        "sharedTemplateUrl": "[uri(deployment().properties.templateLink.uri, 'templateLink/shareddeploy.json')]",
        //params
        "cloudAddressSpace": "10.0.0.0/8",
        "sharedSubnetCidr": "10.1.0.0/24",
        "workloadVnetCidr": "10.2.0.0/16",
        "onPremisesAddressSpace": "192.168.0.0/16",
        "transitRG": "[concat('rg-transit-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix'))]",
        "sharedRG": "[concat('rg-shared-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "name": "[variables('transitRG')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2021-04-01",
            "name": "[variables('sharedRG')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[variables('transitDeploymentName')]",
            "resourceGroup": "[concat('rg-transit-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix'))]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups', concat('rg-transit-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix')))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[variables('transitTemplateUrl')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "cloudAddressSpace": {
                        "value": "[variables('cloudAddressSpace')]"
                    },
                    "sharedSubnetCidr": {
                        "value": "[variables('sharedSubnetCidr')]"
                    },
                    "workloadVnetCidr": {
                        "value": "[variables('workloadVnetCidr')]"
                    },
                    "onPremisesAddressSpace": {
                        "value": "[variables('onPremisesAddressSpace')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "makeSuffix": {
                        "value": "[variables('makeSuffix')]"
                    },
                    "networkWatcherRg": {
                        "value": "[parameters('networkWatcherRg')]"
                    },
                    "transitVnetCidr": {
                        "value": "[parameters('transitVnetCidr')]"
                    },
                    "transitGatewaySubnetCidr": {
                        "value": "[parameters('transitGatewaySubnetCidr')]"
                    },
                    "transitBastionSubnetCidr": {
                        "value": "[parameters('transitBastionSubnetCidr')]"
                    },
                    "transitFwSubnetCidr": {
                        "value": "[parameters('transitFwSubnetCidr')]"
                    }
                }
            }
        }
        // {
        //     "type": "Microsoft.Resources/deployments",
        //     "apiVersion": "2021-04-01",
        //     "name": "[variables('sharedDeploymentName')]",
        //     // "resourceGroup": "[concat('rg-shared-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix'))]",
        //     "resourceGroup": "[variables('sharedRG')]",
        //     "dependsOn": [
        //         "[resourceId('Microsoft.Resources/resourceGroups',concat('rg-shared-',parameters('envName'),'-',parameters('location'),'-',parameters('suffix')))]",
        //         "[resourceId('Microsoft.Resources/deployments',variables('transitDeploymentName'))]"
        //     ],
        //     "properties": {
        //         "mode": "Incremental",
        //         "templateLink": {
        //             "uri": "[variables('sharedTemplateUrl')]",
        //             "contentVersion": "1.0.0.0"
        //         },
        //         "parameters": {
        //             "tags": {
        //                 "value": "[parameters('tags')]"
        //             },
        //             "location": {
        //                 "value": "[parameters('location')]"
        //             },
        //             "makeSuffix": {
        //                 "value": "[variables('makeSuffix')]"
        //             },
        //             "adminObjectId": {
        //                 "value": "[parameters('adminObjectId')]"
        //             },
        //             "lawResourceId": {
        //                 "value": "[reference(variables('transitDeploymentName')).outputs.lawResourceId.value]"
        //             },
        //             "vmAdminUsername": {
        //                 "type": "[parameters('vmAdminUsername')]"
        //             },
        //             "vmAdminPassword": {
        //                 "type": "[parameters('vmAdminPassword')]"
        //             }
        //         }
        //     }
        // }
    ],
    "outputs": {
        "transitResourceGroupName": {
            "type": "string",
            "value": "[variables('transitRG')]"
        },
        "sharedResourceGroupName": {
            "type": "string",
            "value": "[variables('sharedRG')]"
        }
    }
}
